name: Sync to ArgoCD

on:
    push:
        branches:
            - main
    workflow_dispatch:

jobs:
    notify-argocd:
        name: Trigger ArgoCD Sync
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup ArgoCD CLI
              run: |
                  curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
                  chmod +x /usr/local/bin/argocd

            - name: Login to ArgoCD
              env:
                  ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
                  ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
              run: |
                  argocd login $ARGOCD_SERVER --auth-token=$ARGOCD_AUTH_TOKEN --insecure

            - name: Sync All Applications
              env:
                  ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
                  ARGOCD_AUTH_TOKEN: ${{ secrets.ARGOCD_AUTH_TOKEN }}
              run: |
                  argocd app sync root-app --insecure
                  argocd app wait root-app --health --timeout 600

            - name: Notify Success
              if: success()
              run: |
                  echo "✅ GitOps sync completed successfully"
                  # Add Teams notification here if needed

            - name: Notify Failure
              if: failure()
              run: |
                  echo "❌ GitOps sync failed"
                  # Add Teams notification here if needed
